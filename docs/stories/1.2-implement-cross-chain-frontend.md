### **Story 1.2: Implement Cross-Chain Frontend & Wallet Integration**

- **As:** A Frontend Developer
- **I want:** The Quantum Nexus UI to support multi-chain wallet connections, and enable cross-chain deposits and withdrawals
- **So that:** Players can seamlessly manage their funds across EVM, Solana, and TON networks using their preferred wallets.

**Acceptance Criteria (ACs):**

1.  **Multi-chain Wallet Connection:**
    - The application successfully integrates with Particle Network's ConnectKit to support MetaMask (EVM), Phantom (Solana), and TonKeeper (TON) wallets.
    - The UI clearly displays the currently connected blockchain network (e.g., "Ethereum Mainnet", "Solana Devnet", "TON Mainnet").
    - The user's native currency balance for the connected wallet/chain is accurately fetched and displayed in real-time.
    - Wallet connection status (connected/disconnected) is persistent across sessions.
2.  **Cross-chain Deposits:**
    - A dedicated deposit interface is available, listing all supported source chains (EVM, Solana, TON).
    - Users can select a source chain and initiate a deposit transaction.
    - The frontend monitors the deposit transaction status via ZetaChain's CCTX log (`zetachain_cctx_log` table) and provides real-time feedback to the user.
    - Upon successful deposit confirmation on ZetaChain, the user's in-game balance updates immediately.
    - Estimated transaction completion time (within 2 minutes) is communicated to the user.
3.  **Cross-chain Withdrawals:**
    - A withdrawal modal is available, allowing users to select a destination chain (EVM, Solana, TON) for their winnings.
    - Users can specify the withdrawal amount and destination address.
    - Estimated gas fees for the cross-chain withdrawal are clearly displayed to the user before transaction confirmation.
    - The frontend initiates the withdrawal transaction via the `zetaChainService` calling `CrossChainSettlement.sol`.
    - The frontend monitors the withdrawal transaction status and provides updates.
    - Withdrawals process within 5 minutes, and this timeframe is communicated to the user.

**Technical Context:**

- **Wallet Integration:** Utilize Particle Network's Wallet-as-a-Service (WaaS) and ConnectKit for unified wallet management across EVM, Solana, and TON. This includes handling social logins, smart wallets, session keys, and paymasters.
- **Cross-Chain Communication:** All cross-chain operations (deposits/withdrawals) will leverage ZetaChain's protocol. The frontend will interact with the `zetaChainService` (backend API routes) which in turn calls the `CrossChainSettlement.sol` contract on the zEVM.
- **State Management:** User balances and transaction statuses will be managed on the frontend, potentially using a global state management solution (e.g., Zustand, React Context) and persisted via backend API calls to Cloudflare D1.
- **Database Interaction:** The `zetachain_cctx_log` table in Cloudflare D1 (`infra/d1/schema_v2.sql`) will be crucial for tracking cross-chain transaction hashes (CCTX) and their statuses. The `user_preferences` table (using `particle_user_id` as primary key) will store user-specific wallet and chain preferences.
- **UI Components:** Existing components like `TokenSelect.tsx`, `Modal.tsx`, and potentially new components for deposit/withdrawal forms will be used or created.
- **API Endpoints:** New or updated API routes under `src/pages/api/v1/cross-chain-swaps/` will be required to handle deposit and withdrawal requests, interacting with the `zetaChainService`.

**Implementation Tasks:**

1.  **Frontend Setup & Wallet Integration:**
    - Configure Particle Network ConnectKit in the Next.js application to support MetaMask, Phantom, and TonKeeper.
    - Develop a `WalletConnectButton` component that dynamically displays the connected wallet, chain, and native balance.
    - Implement logic to persist wallet connection status and selected chain across user sessions.
    - Integrate Particle Network's session key flow for seamless, low-value transactions.
2.  **Deposit Flow Implementation:**
    - Design and implement a "Deposit" modal/page with a clear chain selection interface.
    - Develop frontend logic to construct deposit transaction payloads for different chains, interacting with the `zetaChainService` API.
    - Implement real-time transaction status tracking by polling or subscribing to updates from the backend (which queries `zetachain_cctx_log`).
    - Update user balance display immediately upon successful deposit confirmation.
    - Add UI elements to show estimated transaction time.
3.  **Withdrawal Flow Implementation:**
    - Design and implement a "Withdrawal" modal/page with destination chain and address input fields.
    - Develop frontend logic to calculate and display estimated gas fees for cross-chain withdrawals.
    - Implement the initiation of withdrawal transactions via the `zetaChainService` API.
    - Implement transaction status tracking for withdrawals.
    - Add UI elements to show estimated withdrawal processing time.
4.  **Multi-chain State Management:**
    - Refactor or create new frontend state management (e.g., using React Context or Zustand) to handle multi-chain wallet data, balances, and transaction states.
    - Ensure `particle_user_id` is consistently used as the primary identifier for user preferences and data across the frontend and backend.
5.  **API Route Development/Update:**
    - Create or update API routes in `src/pages/api/v1/cross-chain-swaps/` to:
      - Handle incoming deposit requests from the frontend.
      - Call the `zetaChainService` to interact with `CrossChainSettlement.sol`.
      - Log CCTX hashes to `zetachain_cctx_log`.
      - Handle incoming withdrawal requests from the frontend.
      - Query ZetaChain for transaction status and update `zetachain_cctx_log`.
6.  **Testing:**
    - Write comprehensive unit and integration tests for all new frontend components and API routes.
    - Test wallet connection for all supported wallets (MetaMask, Phantom, TonKeeper) on various networks.
    - Test end-to-end deposit and withdrawal flows, including edge cases (e.g., insufficient funds, network errors).

**Relevant Files:**

- `src/components/` (for new/updated UI components like `WalletConnectButton`, `DepositModal`, `WithdrawalModal`)
- `src/hooks/` (for custom hooks related to wallet connection, balance fetching, transaction tracking)
- `src/lib/` (for shared utilities related to chain IDs, address formatting, etc.)
- `src/pages/api/v1/cross-chain-swaps/` (for new API routes)
- `src/services/zetaChainService.ts` (potential new service for interacting with ZetaChain backend)
- `src/types/` (for new type definitions related to cross-chain data)
- `infra/d1/schema_v2.sql` (for database schema reference, especially `zetachain_cctx_log` and `user_preferences`)
- `docs/architecture/architecture.md` (for overall system context)
