# Quantum Nexus Architecture Blueprint v1.4 (Complete)

**Governing Document:** This architecture is the technical implementation of `docs/prd.md`. It provides the complete technical design for the project. All development must strictly adhere to this blueprint.

### **1. Core Architectural Principle: The Universal App**

The system is a **Universal App** built on ZetaChain. Our core logic is deployed once to the ZetaChain zEVM and orchestrates interactions with all connected chains, abstracting away their complexity. The frontend, powered by Particle Network's WaaS, interacts with ZetaChain as its primary backend.

### **2. System Overview Diagram**

```mermaid
graph TD
    subgraph User & Onboarding
        A[User via Browser/PWA/Telegram] --> B{Particle Network ConnectKit};
        B -- "Handles Social Login, Smart Wallet Creation, & Gas Sponsoring (Paymaster)" --> C[Quantum Nexus UI on Cloudflare Pages];
    end

    subgraph Presentation & API Layer
        C -- "API Calls" --> D[Next.js API Routes on Cloudflare];
    end

    subgraph Backend & Automation Layer - Cloudflare Workers
        F[Automated Workers (CRON/Event)] -- "Fetches Data & Generates Content" --> G[AI Service Adapter];
        G -- "Uses various LLMs" --> H[External LLM APIs];
        F -- "Writes/Reads" --> I[(Cloudflare D1 Database)];
        D -- "Reads/Writes" --> I;
    end

    subgraph Blockchain Layer
        D -- "Initiates Cross-Chain Actions" --> J[zetaChainService.ts];
        J -- "Calls zEVM Contract" --> K[CrossChainSettlement.sol on zEVM];
        K -- "Instructs ZetaChain Protocol" --> L{ZetaChain Gateway};
        L -- "Executes on Target Chains" --> M[Gamba v2 on Solana];
        L -- "Executes on Target Chains" --> N[Polymarket on EVM];
        L -- "Executes on Target Chains" --> O[TON Contracts];
    end
```

### **3. Smart Contract Architecture (zEVM)**

The smart contract architecture is lean and focused, offloading all cross-chain complexity to the ZetaChain protocol.

*   **`CrossChainSettlement.sol` (The Universal Contract)**
    *   **Deployment:** Only to the ZetaChain zEVM.
    *   **Purpose:** To be the single, chain-agnostic entry point for all cross-chain operations.
    *   **Required Function:**
        ```solidity
        function dispatchCrossChainCall(uint256 destinationChainId, bytes memory destinationAddress, bytes memory message) external payable;
        ```

*   **`PolymarketAdapter.sol` (The Target Contract)**
    *   **Deployment:** To the EVM chain where Polymarket resides (e.g., Polygon).
    *   **Purpose:** To be the *target* of a ZetaChain cross-chain call. It unwraps the message and interacts with the Polymarket protocol.
    *   **Required Function:**
        ```solidity
        function onZetaMessage(ZetaInterfaces.ZetaMessage calldata zetaMessage) external override;
        ```

### **4. Backend Services & AI Engine Architecture**

*   **API Routes (`src/pages/api/`)**: Handle synchronous, user-facing requests.
    *   `/api/v1/tournaments/...`: CRUD endpoints for tournament management.
    *   `/api/smart-bet`: Provides real-time AI bet suggestions.

*   **Cloudflare Workers (`src/workers/`)**: Handle asynchronous, automated tasks.
    *   **`pSeoGenerator-worker.ts`**:
        1.  **Trigger:** CRON schedule (e.g., every 6 hours).
        2.  **Action:** Fetches trending markets from the `polymarketService`.
        3.  **AI Interaction:** Calls the `aiAdapter` to generate a title, meta description, keywords, and a short article for each trending market.
        4.  **Output:** Saves the generated content to the `content_metadata` table in D1.
    *   **`socialPoster-worker.ts`**:
        1.  **Trigger:** New entry in the `content_metadata` table (via a database trigger or a queue).
        2.  **Action:** Constructs a social media post (e.g., for Twitter) using the title and URL from the new entry.
        3.  **Output:** Posts to the configured social media accounts via their respective APIs.

*   **AI Service Adapter (`src/services/aiAdapter.ts`)**:
    *   **Purpose:** A modular service that acts as a unified interface for various LLMs. It will be configured via environment variables.
    *   **Required Function:** `generate({ provider: 'mistral' | 'gemini', type: 'text' | 'image', prompt: string }): Promise<AIResponse>`
    *   This adapter allows us to switch LLM providers without changing the worker code.

### **5. Internationalization (i18n) Architecture**

*   **Framework:** `next-i18next`.
*   **File Structure:** All translation strings will be stored in JSON files within `public/locales/{language_code}/`. For example: `public/locales/en/common.json`, `public/locales/es/common.json`.
*   **Initial Translations:** The initial set of JSON files for the 10 required languages (`en, es, fr, de, it, pt, ru, zh, ja, ko`) will be generated by a script that uses the AI Service Adapter.
*   **Dynamic Content:** Content from the database (like pSEO articles) will be stored in English. It will be translated on-the-fly when requested by a user in a different language, with the results being cached (e.g., in Cloudflare KV) to reduce redundant API calls.

### **6. Database Schema (Definitive)**
The schema defined in the previous blueprint (v1.3) is complete and correct. It includes tables for `user_preferences` (keyed by universal `user_id`), `polymarket_markets` (for caching and pSEO), `zetachain_transactions` (for auditing), and the tournament tables. That schema is the final version.
